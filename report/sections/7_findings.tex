\chapter{Findings}
\label{ch:findings}

% * Repeatable, specific description
% * Provide intuition, key idea
% * State what the problem is that you want to address in that section
% * Describe all parts of life cycle: setup, run, maintenance, etc.
% * Explain with an example (together with the intuition and description, the scheme should have been explained 3 times from different perspectives)
% * Did we really fully explore the design space?
%     * Why are simpler solutions inappropriate?
%     * Explore design alternatives!
%     * Provide intuition on why certain design choices were taken, why alternatives were rejected
%     * Describe a strawman approach, show why it's inadequate

In this chapter, we present the results of our comprehensive security analysis of the CYD Campus SCION system.
It was conducted from late March 2024 through the end of June 2024.
Following our assessment, we reported and discussed our findings with Anapaya in early July 2024.
In response, Anapaya addressed several identified vulnerabilities and released updated software versions for the routers also in July.
After updating the routers, we performed a re-evaluation of the system to assess the effectiveness of the fixes.

We begin this chapter with a brief overview of the findings.
The subsequent Sections \cref{sec:findings:scion-protocol} and \cref{sec:findings:anapaya-router} provide a detailed description of each finding, incorporating Anapaya's statement and an assessment of the current status after the update.
The chapter concludes with the results from our volumetric DoS attacks on the SCION network.

\section{Overview}
\label{sec:findings:overview}

The following table summarizes the findings of our security analysis.
It provides a brief description of each finding, its severity, and whether it has already been mitigated by Anapaya.
Severity levels are categorized as critical, high, medium, or low, depending on the potential impact of each finding.
The first column also includes references to the sections where the finding is discussed in more detail.

% \begin{table}
    % \centering
\renewcommand{\arraystretch}{1.2} % Increase padding
% \renewcommand\tabularxcolumn[1]{m{#1}}
\begin{tabularx}{\textwidth}{|C{3cm}|X|c|c|}
    \hline
    \textbf{Finding} & \textbf{Summary} & \textbf{Severity} & \textbf{Mitigated} 
    \\ \hline

    Missing Source Authentication (\cref{sec:source-authentication}, \cref{sec:spoofing}, \cref{sec:path-extension}, \cref{sec:path-header-modification}) &
    The SCION protocol in use does not provide source authentication based on DRKey, allowing for impersonation, spoofing and path modification attacks. &
    Critical &
    No
    \\ \hline

    Insecure Management System Access (\cref{sec:management-system}) &
    The management systems of the CYD Anapaya routers are misconfigured to allow access without any authentication.
    Additionally, authentication is disabled by default.
    Any AS-local user can access the management web interface and API, allowing for significant changes to the router's configuration. &
    Critical &
    No
    \\ \hline

    Web Server Denial of Service (\cref{sec:web-server}) &
    The web server used for the management system is vulnerable to a denial of service attack known as Rapid Reset.
    This attack consumes the router's resources and eventually crash it, taking down all SCION services. &
    Critical &
    Yes
    \\ \hline

    Lack of Egress Filtering (\cref{sec:spoofing}, \cref{sec:path-extension}) &
    There is no source egress filtering in place.
    This allows to spoof the source information and extend the path header, potentially leading to reflection amplification attacks. &
    High &
    No
    \\ \hline

    Software Vulnerabilities (\cref{sec:vulnerabilities}) &
    The software on Anapaya routers contains several vulnerabilities, including unused binaries, outdated libraries, and kernel vulnerabilities.
    Some of these vulnerabilities can be exploited remotely. &
    Low - High &
    Partially
    \\ \hline

    No Master Secret Refreshment (\cref{sec:mac-algorithm}) &
    The master secret used for deriving the MAC key is not refreshed daily, which is recommended for maintaining good cryptographic hygiene. &
    Medium &
    No
    \\ \hline

    Weak SSH Configuration (\cref{sec:ssh}) &
    The SSH configuration has some weaknesses and allows using less secure algorithms.
    Additionally, there is no rate limiting on login attempts, making the router vulnerable to the DHEat attack. &
    Medium &
    Partially
    \\ \hline

    Ubuntu CIS Compliance Issues (\cref{sec:ubuntu-compliance}) &
    The Anapaya routers do not fully comply with the CIS Ubuntu Linux 22.04 LTS audit.

    We identified several misconfigurations, including the lack of password policy, missing shell timeout, world-writable directories, and enabled SSH root login. &
    Medium &
    Partially
    \\ \hline

    Exposed Systemd Services (\cref{sec:systemd-services}) &
    Many systemd services have a high exposure score, suggesting a high attack surface and a lack of hardened configuration. &
    Medium &
    Partially
    \\ \hline

    Docker Issues (\cref{sec:docker}) &
    The Docker image used to run the SCION services is based on an outdated distroless Debian image and contains unused and vulnerable binaries.
    Additionally, Docker's live restore feature is disabled, and resource limits for individual containers are not set. &
    Medium &
    Partially
    \\ \hline


    \caption{Summary of Findings}
    \label{tab:findings_summary}
\end{tabularx}
% \begin{table}[H]
%     \centering

% \end{table}


\section{SCION Protocol}
\label{sec:findings:scion-protocol}
This section presents the findings of our security analysis of the SCION protocol.
In \cref{tab:software_scion_versions} the investigated SCION software versions are listed for each location before and after the software update.
More information on the software version can be found on Anapaya release notes website \cite{anapayaApplianceReleases}.

\begin{table}[H]
    \centering
    \begin{tabular}{|l|c|c|}
        \hline
        \textbf{Location} & \textbf{Initial Version} & \textbf{Updated Version} \\
        \hline
        ZÃ¼rich & v0.35.4 & v0.36.3 \\
        \hline
        Thun & v0.34.1 & v0.36.2 \\
        \hline
        Lausanne & v0.35.4 & v0.36.3 \\
        \hline
    \end{tabular}
    \caption{Analyzed SCION software versions before and after the update.}
    \label{tab:software_scion_versions}
\end{table}

\subsection{MAC Algorithm}
\label{sec:mac-algorithm}
We compared the MAC algorithm used in the Anapaya version of SCION with the one available in the open source version.
Initially, we extracted the master secret from the file system and derived a MAC key in accordance with the definitions provided in the open source code.
Using this derived MAC key, we calculated the MAC value for a given hop field.
Our calculation matched the original MAC value, confirming the use of the open source MAC algorithm.
This algorithm, which is an AES-CMAC, is considered secure in terms of unforgeability.

In a discussion with Professor Perrig, it was highlighted that the master secret should be refreshed daily to maintain good cryptographic hygiene.
However, this practice is not followed on the Anapaya routers, as they consistently use the same master secret value.

Furthermore, we verified that the MAC value is being validated during transmission of a SCION packet.
Upon altering the MAC value or introducing unauthorized hop fields, the packet was correctly dropped by the Anapaya router.
This check ensures that no new path can be created, not even by combining it out of two valid ones.
Our tests confirmed the infeasibility of these manipulations.

\begin{boxH}
\paragraph{Anapaya:}
``The Anapaya appliance is inline with the current SCION ecosystem where there is currently no automatic forwarding key rollover. Our appliance relies on the open source implementation for path creation and discovery.
The issue is known and on the roadmap of the open source implementation https://github.com/scionproto/scion/issues/4348.

However, we want to highlight that there is currently no practical attack on AES-CMAC to recover the key.
Thus a successful attack is unlikely. Furthermore, in a scenario of a key compromise, an AS can manually roll over their key at will.''
\end{boxH}

\paragraph{Current Status:}
The current implementation of the MAC algorithm on Anapaya routers remains unchanged, with no mechanism for key refresh in place.
Despite recommendations for implementing daily master secret refreshes to improve cryptographic hygiene, this feature has not yet been adopted.
While the AES-CMAC algorithm in use continues to be secure, the absence of a daily key refresh remains a notable area for future enhancement within the SCION protocol and its implementations.

\subsection{Source Authentication / DRKey}
\label{sec:source-authentication}
Following the cryptographic analysis of the MAC algorithm, we examined another cryptographic related aspect of SCION: Source authentication based on DRKey.
This analysis turned out to be a short one, as we found that DRKey is not used in the SCION implementation on the Anapaya routers.
The lack of DRKey support enables various attacks on the SCION network.
For example, unauthenticated SCMP error messages can be injected into the network.
By sending an \textit{external interface down} SCMP error message, an off-path attacker can possibly force retransmission of SCION packets on another path.

\begin{boxH}
\paragraph{Anapaya:}
``The Anapaya appliance is inline with the current SCION ecosystem where there is currently no support for SCMP authentication. The SCION community has not reached a final agreement on whether SCMP authentication should be supported, or in what manner.

We want to highlight that there are also mitigation strategies without SCMP Authentication. E.g., by validating the quoted packet in the SCMP message has been sent by the application.''
\end{boxH}


\paragraph{Current Status:}
Although DRKey support and SCMP message authentication were introduced in the open-source version of SCION with release v0.9.0 on October 17, 2023, these features remain experimental and are disabled by default \cite{SCIONReleaseV090}.
Despite the availability of DRKey in the SCION ecosystem, Anapaya has not yet adopted this functionality.
During the disclosure process, we emphasized to Anapaya that enabling DRKey could substantially enhance network security and facilitate the development of new applications relying on this technology.
However, Anapaya has not incorporated DRKey in their current implementation, therby leaving the network vulnerable to attacks such as unauthenticated SCMP error message injection.


\subsection{Spoofing}
\label{sec:spoofing}
With the finding that the source is not authenticated, we investigated the possibility of spoofing the source information.
We altered the IP address as well as ISD-AS information and successfully transmitted the packet to the intended destination.
This demonstrates that no outbound filtering is active, allowing for source information spoofing.
If the destination application reverses the path information of the initial packet to send the reply, the response will return to the source AS rather than the spoofed one.
In the case of unidirectional paths or if the destination has a specific path policy defined, the destination may perform a path lookup based on the source information.
This scenario would result in a successful spoofing, where the spoofed location receives the packet.
Moreover, this can lead to reflection amplification attacks, particularly when the destination sends more data than the sender initially transmitted.
This can be exploited to launch denial-of-service attacks against the spoofed location.

\begin{boxH}
\paragraph{Anapaya:}
``This is a hypothetical scenario with a server that is susceptible to reflection attacks by spawning path requests based on unconnected requests. None of the Anapaya authored applications behave this way, nor are we aware of any applications in the SCION ecosystem with this behavior. Well authored server applications should not do work in response to unconnected client requests.''
\end{boxH}

We also attempted to force a path lookup at the recipient, assuming it would reverse the path information to reply.
The strategy involves using path segments that are about to expire.
The initial packet would use valid path segments, but when the destination reverses the path during the reply, the path segments would have already expired.
Depending on the application this could lead to a forced path lookup based on the spoofed source information, resulting in successful spoofing.
However, during our analysis, we observed that the Anapaya border router implementation drops network packets that have a path information that is going to expire in the next 30 seconds or less.
This behavior shifts the attack windows from the actual expiration time to 30 seconds prior to it.


This is a significant divergence from the open-source implementation.
As illustrated in the pseudocode in \cref{lst:hop-expiry}, the open-source implementation only checks if the packet has expired based on the current time.
It does not account for the 30 additional seconds as observed in the Anapaya implementation.



\begin{lstlisting}[language={Go}, morekeywords={}, caption={Pseudocode of hop expiry check in open-source implementation of the border router.}, label={lst:hop-expiry}]
func (p *packetProcessor) (*@\textcolor{blue}{validateHopExpiry}@*)() (processResult, error) {
    expiration := util.SecsToTime(p.infoField.Timestamp).
        Add(path.ExpTimeToDuration(p.hopField.ExpTime))
    expired := expiration.Before(time.Now())
    if !expired {
        <move on with packet processing>
    }
    <drop packet + send SCMP packet with path expiry (*@error@*)>
}
\end{lstlisting}


To mitigate these vulnerabilities, we recommend adding egress source filtering to the border router implementation.
This measure would prevent malicious end hosts from performing such spoofing attacks.
Additionally, outbound filtering also directly enhances security for AS customers \cite[Section 7.7.3]{Perrig2022}, providing even higher incentives for ASes to perform egress filtering.
Source authentication is another effective solution to mitigate these attacks.
SPAO based on DRKey even provides source authentication on the first packet sent.
However, for this to be used, the DRKey feature must first be enabled by Anapaya.

\begin{boxH}
    \paragraph{Anapaya:}
    ``[...] the DRKey feature needs to be first accepted by the SCION community. As soon as it is, Anapaya will of course add support for it.''
\end{boxH}


\paragraph{Current Status:}
Spoofing remains possible due to the absence of outbound source filtering, which continues to allow source information to be manipulated.
While some attacks are currently hypothetical, they could pose real risks if conditions change or if applications do not adhere to best practices.
Additionally, while the implementation's path expiry behavior differs from the open-source version, this issue has not yet been addressed or rectified.
Recommendations for implementing egress source filtering and enabling the DRKey feature to enhance source authentication are still pending adoption.
As a result, the vulnerabilities related to spoofing persist, and addressing them remains a crucial step for improving overall security.


\subsection{Path Extension}
\label{sec:path-extension}
For a spoofing or also denial-of-service attack, it is advisable to masquerade the source information; otherwise such a malicious source can be easily identified and blocked.
During our security analysis, we attempted to achieve this by altering and extending the SCION header.
As presented in the previous section, the source information can be spoofed.
Leveraging this knowledge, we modified the source to be a different (even made up) AS.
Additionally, we prepended the path header with extra hop fields and set the hop field index to the correct value.
These modifications to the path header are illustrated in \cref{extended_path_header}.
The hop fields marked in red represent the additional entries we inserted, while the ones fields indicate the original fields.
The up-segment length is set to eight, reflecting the inclusion of the six extra hops.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.5\textwidth]{extended_path_header.drawio.png}
    \caption{Extended path header with additional hop fields.}
    \label{extended_path_header}
\end{figure}

The adjustments cause the packet to appear as if it was sent by a customer of our AS.
The modified packet was successfully transmitted to the destination, which reverted the path information and sent the reply back to our AS.
This demonstrates that the path header can be extended with additional and invalid hop fields, allowing for the spoofing of the AS that originated the connection.
Implementing a simple check to filter packets with a hop field index set to zero (i.e., pointing to the first hop) for packets originated from AS-local end hosts would mitigate this issue.
However, this check does not protect against malicious ASes.
To address this threat, source authentication (e.g., SPAO) would be once again be an effective solution.
But again, this feature and DRKey are unfortunately not enabled in the Anapaya routers.

Given the ability to extend the path at will, we also assessed the impact of extending the path to the maximum length (i.e., 64 hop fields).
The destination must process and revert all these hops, which may lead to increased processing time and potentially result in a denial-of-service attack.
For this evaluation, 100 normal SCION pings were sent form the Kali machine in ZÃ¼rich to the Anapaya router in Thun.
Additionally, 100 SCION pings with a modified path header containing the maximum number of hop fields were sent.
At the destination, the processing time was measured and is plotted in the following:

\begin{figure}[h]
    \centering
    \includegraphics[width=0.75\textwidth]{processing_times_path_lengths.png}
    \caption{Processing times of a SCION ping with different path lengths.}
    \label{fig:path_extension}
\end{figure}

The results indicate that the processing time for the SCION pings with the maximum path length is slightly higher than for the normal SCION pings.
This simple evaluation demonstrates that the impact of extending the path to its maximum length is minimal and largely negligible.


\begin{boxH}
    \paragraph{Anapaya:}
    ``We will introduce egress filtering in an upcoming release.
    However, we deem the risk of this affecting real applications as very low.''
\end{boxH}

\paragraph{Current Status:}
Anapaya has recognized the difficulty of implementing a check for zero hop fields due to the complexities of distinguishing local AS traffic from sibling router traffic.
Despite these challenges, they are committed to introducing this check in an upcoming release.
This measure is expected to mitigate the risk posed by malicious end hosts attempting to exploit path extension vulnerabilities.
Therefore, the added check will reduce the potential for spoofing attacks by filtering out invalid path extensions, thereby improving the security of the SCION network against such threats.

\subsection{Path Header Modification}
\label{sec:path-header-modification}
This section addresses the modification of the path header by an on-path attacker rather than by the source.
This attack is also discussed in section 7.6.1 of the SCION book \cite{Perrig2022} and works as follows:
An attacker intercepts a SCION packet and modifies the path header by replacing path segments as desired.
The packet is then forwarded along the attacker chosen path rather than the original path intended by the sender.
These modifications can be reverted by the adversary in replies from the destination (e.g., when the destination inverts the path header to reply), making the sender unaware of the attack.
Our analysis within the CYD SCION network confirmed the feasibility of this attack.

To ensure that the selected path is actually used during transmission, the packet must be integrity protected.
A SCION built in solution would be the SCION packet authenticator option, but this feature is not enabled in the Anapaya routers.
Therefore, clients must implement their own solutions to ensure the integrity of the path header.
For instance, this can be achieved by adding a MAC to the entire packet or by comparing the path information of the received packet with the expected path information.

\begin{boxH}
\paragraph{Anapaya:}
``This attack is feasible in the base SCION protocol, hence there is no mitigation in the Anapaya appliance. As soon as the DRKey feature has been accepted by the SCION community and an implementation is available, it will be integrated in the Anapaya appliance.''
\end{boxH}

\paragraph{Current Status:}
The current status regarding path header modification reveals that this vulnerability remains exploitable.
An attacker can still intercept and alter the path header of a SCION packet, rerouting it according to their own choice, while the sender remains unaware due to the potential for the path modifications to be reverted in replies.
Although this attack vector is confirmed to be feasible within the CYD SCION network, the situation is somewhat mitigated by SCION's concept of isolation domains.
ISDs restrict routing paths so that communication parties within the same ISD can only communicate on paths that remain within the same ISD, thus limiting the impact of such attacks.
However, this does not eliminate the risk entirely.
To address this issue effectively, it is essential that SCION users and Anapaya customers are made more aware of this vulnerability.
In the absence of SPAO on Anapaya routers, clients are advised to implement their own integrity protection measures, such as incorporating a MAC for the entire packet or verifying the path information against expected values.

\section{Anapaya Router}
\label{sec:findings:anapaya-router}
This section deals with the security related findings of the three operational Anapaya routers at the CYD Campus.
The devices run Ubuntu 22.04 as the operating system with Linux Kernel 5.15.0.
\cref{tab:system_software_versions} shows the specific software versions of the system packages before and after the update at each CYD Campus location.
The system package release page \cite{anapayaSystemPackage} provides more information on the individual versions.

\begin{table}[h]
    % ZÃ¼rich: v2.9.10, updated to v2.12.0 (step v2.11.6)
    % Thun: v2.8.0, updated to v2.11.4 (step v2.11.4)
    % Lausanne: v2.9.10, updated to v2.12.0 (step v2.11.6)
    \centering
    \begin{tabular}{|l|c|c|}
        \hline
        \textbf{Location} & \textbf{Initial Version} & \textbf{Updated Version} \\
        \hline
        ZÃ¼rich & v2.9.10 & v2.12.0 \\
        \hline
        Thun & v2.8.0 & v2.11.4\\
        \hline
        Lausanne & v2.9.10 & v2.12.0\\
        \hline
    \end{tabular}
    \caption{Investigated versions of the system package before and after the update.}
    \label{tab:system_software_versions}
\end{table}



\subsection{Secure Shell (SSH)}
\label{sec:ssh}
The Anapaya routers are accessed via SSH with public key authentication and do not allow password authentication.
This is considered a robust security practice, as public key authentication is more secure than password authentication.
This is due to the higher entropy of key compared to passwords, and the fact that keys are not transmitted over the network.
However, our analysis identified some shortcomings with the SSH configuration that could be improved:

\begin{itemize}
    \item Various algorithms use elliptic curves cryptography (ECC) on curves that are believed to have been compromised by the National Security Agency (NSA) \cite{nist1_safecurves}.
    \item Some MAC algorithms use the broken SHA1 hash function, which potentially allows for collision attacks.
    \item The chacha20-poly1305@openssh.com cipher is enabled, which is susceptible to the Terrapin attack (CVE-2023-48795).
    This attack allows message prefix truncation, which enables an attacker to downgrade the security of a connection.
    \item A key exchange algorithm based on Diffie-Hellman group 14 is enabled. It uses a 2048-bit modulus, but only provides 112 bits of security.
    \item Some MAC algorithms are using the encrypt-and-MAC construction, which does not provide integrity of the ciphertext and can possibly leak information of the plaintext.
    It is recommended to use encrypt-then-MAC instead.
    \item Lastly, it should be noted that there are MAC algorithms enabled with a tag length of only 64 bits.
\end{itemize}

To improve the security of the SSH configuration, it is recommended to disable the aforementioned algorithms.
A detailed guide on implementing these changes can be found on this website \cite{sshauditHardeningGuides}.


Furthermore, it was found that the SSH server does not perform any rate limiting on login attempts.
Consequently, it is vulnerable to the DHEat denial of service attack \cite{dheatAttack}, where an attacker sends many Diffie-Hellman keys to the server, which then has to perform numerous expensive modular exponentiation and wasting CPU resources.
An attacker can also just send random big numbers, therefore avoiding computing valid keys.
Our experiments demonstrated that this attack could fully consume the CPU resources of the Anapaya routers in a matter of seconds.
However, due to the SCION dataplane's allocation on a dedicated CPU core, the impact on SCION functionality was minimal.
Nonetheless, other services, such as new SSH login attempts, experienced delays or were not even possible anymore.
To mitigate this attack, it is recommended to implement rate limiting on the SSH server, as it was shown in detail in this blog post \cite{dheatAnalysis}.

\begin{boxH}
\paragraph{Anapaya:}
``The firewall rules on the Anapaya appliance can be adjusted to enable rate limiting. In a future release, we will change the default firewall configuration to also take rate limiting into account.''
\end{boxH}

\paragraph{Current Status:}
The SSH configuration on the Anapaya routers has undergone improvements since our initial disclosure.
Anapaya has addressed the issue of weak algorithms by disabling those identified as compromised or vulnerable.
Despite these enhancements, as of the time of writing, rate limiting has not yet been implemented on the SSH server.
As a result, the system remains susceptible to the DHEat denial of service attack, which can overwhelm the server's CPU resources.
Anapaya has acknowledged this issue and plans to incorporate rate limiting in a future version of the appliance's default configuration.


\subsection{Ubuntu Compliance}
\label{sec:ubuntu-compliance}
By attempting to log in to the Anapaya routers via SSH, we observed that there is no banner displayed.
Banners usually contains a legal disclaimer that non-authorized access is prohibited and that activity may be monitored.
This can be crucial for legal compliance and for protecting the organization in the event of unauthorized access.
This is one of a few examples where the Anapaya router does not comply with the Ubuntu security guidelines.
In the following, we will discuss misconfigurations not complying with the CIS Ubuntu Linux 22.04 LTS audit \cite{cisUbuntuLinux2204LTS}.
Numbers in parentheses in this section refer to the corresponding section in the audit.

\begin{itemize}
    \item On two of the three examined routers, there is no password or other re-authentication needed to escalate privileges to root (5.2.4).
    \item While the systems are configured to only accept at least 6 characters long passwords, there is no password policy in place.
    For example, password complexity is not enforced (5.3.3.2.3) and also password reuse is not restricted (5.3.3.3.1).
    \item There is no shell timeout configured, which would log out an inactive user after a certain time (5.4.3.2).
    By setting a timeout, the risk of unauthorized access to the system can be reduced and also frees up resources associated with the idle session.
    \item Shared memory (the directory \texttt{/dev/shm}) can contain executable files, as the noexec option is not set (1.1.2.2.4).
    This option would prevent users from executing binaries from shared memory, which could be used to introduce malicious software into the system.
    \item The directories \texttt{/tmp} as well as \texttt{/var} are not mounted on separate partitions (1.1.2.1.1 and 1.1.2.4.1).
    Both directories are either world-writable or contain world-writable directories or files, which can be exploited to fill up the whole disk and impact the system's availability.
    Additionally, if the directories were mounted on separate partitions with the noexec option, it would prevent other attacks.
    For example an attacker could hard-link a system setuid binary to these locations and wait for it to be updated.
    After such an update, the hard-link would be broken and the attacker has its own copy of the setuid binary.
    If the binary has a security vulnerability it could be exploited to escalate privileges.
    \item There is no separate partition for the \texttt{/home} directory (1.1.2.3.1).
    Again, a user can fill up the disk and impact the system's availability.
    \item The permissions on crontab files are misconfigured (2.4.1.2 - 2.4.1.8) and can be read by unauthorized users.
    These files contain information about scheduled jobs, thus allowing an attacker to gain information about system jobs and potentially exploit them to escalate privileges.
    \item USB storage devices are not restricted (1.1.1.8) and therefore increases the physical attack surface.
    It can be misused to introduce malicious software into the system or to exfiltrate data.
    \item The SSH \texttt{LoginGraceTime} parameter is slightly set too high (5.2.13).
    This parameter specifies the time in seconds that the server allows for a successful login before disconnecting.
    A shorter time would reduce the risk of brute force attacks.
    Currently, the parameter is set to 120 seconds, but it is recommended to set it to 60 seconds.
    \item Root SSH login is enabled (5.2.20).
    By disabling root login over SSH, forces users to authenticate with their own account and then escalate privileges to root.
    This provides a clear audit trail and limits non-repudiation.
\end{itemize}


There are more compliance mismatches found during the audit.
Mostly related to ensure clear audit trails, including monitoring and logging of security-relevant events, or to disable unnecessary kernel modules
The full list of findings can be found \cref{app:automated-scan-result}.


\begin{boxH}
\paragraph{Anapaya:}
``The Anapaya appliance is not intended as a general purpose OS, and thus does not have arbitrary user accounts. This reduces the risks of some of the violated compliance requirements considerably.

For this reason, we also do not deem a strict password policy critical, given there are no arbitrary users on the system.''
\end{boxH}


\paragraph{Current Status:}
The current status with respect to Ubuntu compliance on the Anapaya routers shows both partial improvements and ongoing concerns.
Notably, the shell timeout configuration has been addressed, and the SSH \texttt{LoginGraceTime} parameter has been reduced to 60 seconds, enhancing security against brute-force attacks.
Nevertheless, several other compliance issues remain unaddressed.
Anapaya has determined that many of these issues are not critical due to the appliance's specific use case and lack of arbitrary user accounts.
Despite this, some aspects, such as an enabled login prompt and disabled root SSH login, could still be crucial for organizations that need a clear audit trail or that face potential security incidents.
The absence of these measures might complicate post-incident prosecution and auditing processes.

\subsection{Security of systemd Services}
\label{sec:systemd-services}
As seen in the previous section, the routers operating system can be optimized to ensure a higher level of security.
In this section, we will focus on the security of the systemd services running on the Anapaya routers.

For this purpose, we analyzed the services by running the \texttt{systemd-analyze security} command.
It evaluates the security settings and provides a score for each systemd service
This score is calculated based on the security features enabled for the service.
A higher score indicates a more exposed and potentially less secure service, whereas it only scores the configuration of the service.

The command can also be run on a single service, which then provides a detailed report on how the score was calculated.
In the following the output of the command and the scoring of the individual services is shown.


\TODO{Maybe try to add emojis here to output}

\begin{lstlisting}[language=bash, deletekeywords={local}, numbers=none, caption={Output of \texttt{systemd-analyze security} on the device in Thun running Anapaya's system version v2.8.0.}]
$ systemd-analyze security
UNIT                                  EXPOSURE PREDICATE 
ModemManager.service                       6.3 MEDIUM    
appliance-controller.service               9.6 UNSAFE    
appliance-installer.service                9.6 UNSAFE    
apport.service                             9.6 UNSAFE    
caddy.service                              8.8 EXPOSED   
cloud-init-hotplugd.service                9.6 UNSAFE    
containerd.service                         9.6 UNSAFE    
cron.service                               9.6 UNSAFE    
dbus.service                               9.5 UNSAFE    
dm-event.service                           9.5 UNSAFE    
dmesg.service                              9.6 UNSAFE    
docker.service                             9.6 UNSAFE    
emergency.service                          9.5 UNSAFE    
getty@tty1.service                         9.6 UNSAFE    
irqbalance.service                         6.2 MEDIUM    
iscsid.service                             9.5 UNSAFE    
lvm2-lvmpolld.service                      9.5 UNSAFE    
lxd-agent.service                          9.5 UNSAFE    
multipathd.service                         9.5 UNSAFE    
networkd-dispatcher.service                9.6 UNSAFE    
open-vm-tools.service                      9.5 UNSAFE    
packagekit.service                         9.6 UNSAFE    
plymouth-start.service                     9.5 UNSAFE    
polkit.service                             9.6 UNSAFE    
rc-local.service                           9.6 UNSAFE    
rescue.service                             9.5 UNSAFE    
resolvconf.service                         9.5 UNSAFE    
rsyslog.service                            9.6 UNSAFE    
serial-getty@ttyS0.service                 9.6 UNSAFE    
snap.lxd.daemon.service                    9.6 UNSAFE    
snap.lxd.user-daemon.service               9.6 UNSAFE    
snapd.aa-prompt-listener.service           9.6 UNSAFE    
snapd.service                              9.6 UNSAFE    
ssh.service                                9.6 UNSAFE    
systemd-ask-password-console.service       9.4 UNSAFE    
systemd-ask-password-plymouth.service      9.5 UNSAFE    
systemd-ask-password-wall.service          9.4 UNSAFE    
systemd-fsckd.service                      9.5 UNSAFE    
systemd-initctl.service                    9.4 UNSAFE    
systemd-journald.service                   4.3 OK        
systemd-logind.service                     2.8 OK        
systemd-networkd.service                   2.9 OK        
systemd-resolved.service                   2.1 OK        
systemd-rfkill.service                     9.4 UNSAFE    
systemd-timesyncd.service                  2.1 OK        
systemd-udevd.service                      6.9 MEDIUM    
thermald.service                           9.6 UNSAFE    
ubuntu-advantage.service                   9.6 UNSAFE    
udisks2.service                            9.6 UNSAFE    
upower.service                             2.4 OK        
user@1000.service                          9.4 UNSAFE    
uuidd.service                              4.6 OK        
vgauth.service                             9.5 UNSAFE    
\end{lstlisting}

As one can see, many services are considered unsafe.
It is recommended to either disable unused services or to harden the configuration of the services to minimize the attack surface.

For example the \texttt{open-vm-tools} and \texttt{vgauth} services are related to VMware, but as on the routers no virtual machine is being used, these services can be disabled.
Also, the \texttt{ModemManager} service is not needed, as the router is not a modem and does not use mobile broadband (e.g., 2G/3G/4G) connections.
Furthermore, since the routers do not use WiFi or Bluetooth, also the \texttt{systemd-rfkill} service can be disabled.
Ubuntu Advantage is a subscription service that provides additional security features, such as livepatching, compliance checks, technical support and more.
As the Anapaya routers are not connected to the internet and are updated out-of-band, the \texttt{ubuntu-advantage} service is not needed and can be disabled.

Finally, it is also worth taking a closer look if the services can be configured more strictly.
Time did not permit to take a deep dive into the functionality of the services of the \texttt{appliance-controller} and \texttt{appliance-installer} of Anapaya.
However, the high exposure score of 9.6 indicates that these services were not configured to minimize the attack surface.
They enjoy a high level of capabilities and practically no restrictions.
We recommend reviewing the services and to restrict the rights to the minimum required for the services to function properly.

\begin{boxH}
\paragraph{Anapaya:}
``We will assess how the surface of the systemd services can be reduced exposure where unneeded.''
\end{boxH}

\paragraph{Current Status:}
The current state of the security of systemd services on the Anapaya routers reflects both progress and persistent issues.
The latest software update has removed over ten services, including the \texttt{ModemManager} service, which was identified as unnecessary and potentially insecure.
Despite these improvements, the systemd-rfkill service, which is also considered redundant for the routers' operational context, remains present.
Moreover, services specific to Anapaya's specific functions, such as \texttt{appliance-controller} and \texttt{appliance-installer}, continue to exhibit high exposure levels, with scores of 9.6.

While steps have been taken to reduce the attack surface, further actions are recommended to address the high exposure levels and ensure that all services are configured with optimal security measures.


\subsection{Vulnerabilities}
\label{sec:vulnerabilities}

In addition to ensuring the secure configuration of systemd services, it is also crucial to keep the software up-to-date.
This section provides an overview of vulnerabilities identified in the software running on the Anapaya routers.
The vulnerabilities were identified using a Nessus scan and are based on the software version and the Nessus CVE database.

Most identified weaknesses require local access to the system for exploitation.
Vulnerable versions of several software packages were found on the three devices, including \texttt{bash}, \texttt{vim}, \texttt{less}, \texttt{perl}, \texttt{git}, \texttt{tar}, \texttt{Intel Microcode}, \texttt{glibc}, and \texttt{libarchive}.
Some kernel vulnerabilities were also detected, but these require a local privileged attacker (e.g., one with CAP\_NET\_ADMIN capabilities) to exploit them.
The impact of these vulnerabilities ranges from denial of service attacks caused by system crashes to internal information leakage, to privilege escalation.

However, some vulnerabilities were identified that could be exploited remotely.
There are critical vulnerabilities associated with the drivers of the Intel Ethernet controller, which may allow an unauthenticated user to escalate privileges via network access (see CVE-2023-25775 and CVE-2023-45871 for more details).
Although some packages installed on the routers are vulnerable and could be exploited remotely, these packages are not actively used or running on the routers.
It is recommended to either update the affected packages or, preferably, remove unused software entirely to further reduce the attack surface.

A detailed report on all identified vulnerabilities can be found in \cref{app:automated-scan-result}.

\begin{boxH}
\paragraph{Anapaya:}
``At the time of scanning for these vulnerabilities, Anapaya has already published multiple newer releases of the anapaya-system packages with patches for the aforementioned vulnerabilities. The packages have simply not been installed.''
\end{boxH}

\paragraph{Current Status:}
The most recent software releases have mitigated the majority of the vulnerabilities previously identified.
However, some concerns persist, including outdated versions of OpenSSL within Docker containers and vulnerable Python and OpenSSL libraries on the system.
Additionally, certain vulnerabilities persist on the device located in Thun, which has not been updated to the latest version by Swisscom.
Notably, it is vulnerable to the critical vulnerabilities related to the Intel Ethernet controller driver.
It is recommended to update or remove outdated and unused software to further reduce the attack surface and enhance overall system security.

\subsection{Docker}
\label{sec:docker}
% libc6 libssl1.1 openssl 1.1.1k

The individual services of the Anapaya router are containerized using Docker.
We conducted an automated and manual analysis of these containers to identify potential vulnerabilities.
The Docker images are based on Google's distroless Debian 11.1 base image \cite{githubGitHubGoogleContainerToolsdistroless}.
Such distroless images include only the necessary dependencies and omit a full operating system, which reduces the attack surface and enhances security.
However, our analysis revealed that this base image still contains unused binaries, such as \texttt{openssl}, its corresponding library \texttt{libssl}, and \texttt{c\_rehash}.
Furthermore, these binaries are outdated and vulnerable to various security threats, including command injection, use-after-free, double free, and denial of service attacks.
To improve the security of these Docker containers, it is recommended to remove these unused binaries by switching to the no-ssl variant of the distroless image (see \cite{githubGitHubGoogleContainerToolsdistroless}).

Further analysis of the libraries actually used to run the containers revealed that \texttt{libc} is outdated and has known vulnerabilities.
Although we were unable to directly exploit these vulnerabilities, it is recommended to update \texttt{libc} to the latest version to mitigate potential security threats.
Additionally, using the latest version of the Debian base image (currently version 12) is advisable.

Apart from the base image, it was observed that the live restore feature of Docker is not enabled.
Enabling this feature allows containers to continue running even if the Docker daemon is stopped during a crash or a planned update.
Without this feature, all running containers would stop if the daemon becomes unavailable, potentially leading to data loss and downtime for SCION services.
To ensure a higher availability of the SCION services, it is recommended to enable Docker's live restore feature.

Finally, to further improve availability, we suggest implementing resource limits for the Docker containers.
The inspected systems currently lack resource limits for the Docker containers.
Setting such limits would prevent a single container from consuming all the router's resources, potentially crashing it and impacting all SCION services.

\begin{boxH}
\paragraph{Anapaya:}
``The next release v0.37 will include docker images based on debian 12. The docker live restore feature is disabled on purpose as we implement our own watchdog functionality to bring back the services. Most docker based services did have CPU limits set, but lacked memory limits in older releases. As of v0.36, most services have both CPU and memory limits set. Furthermore, the operator can tune these limits via the appliance configuration to further harden their system.
''
\end{boxH}

\paragraph{Current Status:}
The transition to a Debian 12 base image is confirmed for the next release, addressing the need for an updated and secure foundation.
Additionally, the use of the no-ssl variant of the distroless image is anticipated, which will eliminate unnecessary and potentially vulnerable binaries.

Resource limits for Docker containers, though present in version 0.36, are not activated by default.
This lack of default configuration makes it challenging for administrators to determine appropriate resource allocations for individual containers.
To enhance overall system stability and prevent resource exhaustion by any single container, it is recommended that Anapaya implement predefined resource limits.


\subsection{Management System}
\label{sec:management-system}
The management system of Anapaya enables administrators to easily configure their SCION setup.
This system is accessible via an API or a web interface.
The latter is shown in \cref{fig:anapaya_web_interface}.

\begin{figure}
    \centering
    \includegraphics[width=0.75\textwidth]{management_web.png}
    \caption{Anapaya router's management web interface.}
    \label{fig:anapaya_web_interface}
\end{figure}

Currently, no authentication is required for the CYD SCION users to access the management system.
Access is granted solely based on knowledge of the IP address of the border router.
This configuration allows users to make significant changes to the border router's configuration, including the following:

\begin{itemize}
    \item Altering firewall rules
    \item Reading and modifying SCION the forwarding key, which is used in the MAC calculations
    \item Changing DNS and NTP server settings
    \item Adding new TRCs
    \item Completely disabling the router
    \item Adding custom authentication options and potentially lock out other users from accessing the management system
\end{itemize}

This lack of authentication was also present on the test device, which shows that no default authentication is set up.
This observation is consistent with the official Anapaya documentation, which states that basic authentication is disabled by default \cite{anapayaManagemenDoc}.
To improve the security of the device and especially the SCION configuration, it is recommended to enable authentication for the management system.
We also encourage Anapaya to enable basic password authentication by default for newly deployed devices.
\TODO{clearify situation}

\begin{boxH}
\paragraph{Anapaya:}
``The Anapaya appliance has a default password configured when it is freshly installed from the base image. The user has to actively push a configuration to with basic auth not enabled for it to be disabled.
We encourage CYD to enable basic auth in their configuration on their appliances to remedy the situation.

We will assess how we can make not enabling basic auth an even more conscious choice.''
\end{boxH}

\paragraph{Current Status:}
Currently, the Anapaya router's management system remains without default authentication, requiring manual configuration by administrators to enable it.
Access to the management web interface and API is still granted solely based on knowledge of the router's IP address, with no inherent authentication mechanisms in place.
The latest software releases even allow for the configuration of device users and authentication, including SSH keys.
Consequently, the absence of authentication on the management system enables attackers to add their SSH keys as well as removing existing ones.
This leads to unauthorized access and complete takeover of the device.


\subsection{Web Server}
\label{sec:web-server}
The management system is also being served by a web server running on the router, accessible to any AS-local SCION user or any remote user in an AS with a configured SIG connection.
The web server in use is Caddy, version 2.6.4, released in February 2023.
This version is vulnerable to a denial of service attack known as Rapid Reset \cite{googleWorksNovel}, which exhausts the routers resources and eventually crashes it, thereby taking down all its services, including SCION.
The Rapid Reset attack is depicted in \cref{fig:rapid_reset} and exploits the HTTP/2 protocol's capability to open multiple streams within a single TCP connection.
Unlike standard HTTP/2 attacks that are constrained by a server-defined limit of open streams (e.g., 100 streams), the Rapid Reset attack can rapidly open and close an unlimited number of streams.
The stream closure (i.e., resetting) is accomplished by sending a RST\_STREAM frame.
By opening and closing streams in quick succession, the attacker ensures that the number of active streams remains within the server's limit.
Nonetheless, the server still has to perform substantial work for these canceled requests, including allocating memory for a new stream, parsing the query, performing header decompression, and other tasks \cite{googleWorksNovel}.

\begin{figure}
    \centering
    \includegraphics[width=0.75\textwidth]{rapid_reset.png}
    \caption{Illustration of HTTP/2 attacks \cite{googleWorksNovel}.}
    \label{fig:rapid_reset}
\end{figure}

By modifying the code in an existing proof-of-concept attack \cite{githubGitHubMicrictorhttp2rststream}, we were able to attack our Anapaya router and finally taking it down withing a few seconds.
Notably, this attack is effective even when the management system is configured with authentication, as the web server itself is not protected by it.

The recommended solution to mitigate this vulnerability is to update the Caddy web server to version 2.7.5 or later, which addresses the Rapid Reset attack \cite{githubReleasesCaddyservercaddy}.

\begin{boxH}
\paragraph{Anapaya:}
``The system package includes Caddy 2.7.5 as of version v2.9.0 which was released on 14.02.2024, and hence was already published at the time of the scan.''
\end{boxH}

\paragraph{Current Status:}
Anapaya has upgraded the Caddy web server to version 2.7.5 and later, which effectively mitigates the Rapid Reset attack.
As a result, the previously identified denial of service vulnerability, which exploited the HTTP/2 protocol to overwhelm and crash the router, is no longer a concern.
As a result, the updated devices are protected from this attack vector, ensuring that the web server remains stable and resilient against similar exploitation attempts.

\subsection{General Recommendations}
\label{sec:general-recommendations}
% Test device shipped at begging of May 2024:
% - software/system/installed v2.8.0  -> dating back to end of september 2023 (2023-09-27T08:26:15.248888+00:00")
% - appliance v0.34.1                 -> 2023-10-20T13:45:22.216754+00:00

It is crucial to keep the software up-to-date to mitigate potential security threats.
The Anapaya routers should be updated regularly to ensure that the latest security patches are applied.
In May 2024, CYD bought and received a new Anapaya Router.
The system and SCION software versions on this new device were outdated and contained the software releases of autumn 2023 (end of September and mid of October).
An improvement on Anapaya's side would be to ship the routers with a more recent software version, ideally the latest release.

\begin{boxH}
\paragraph{Anapaya:}
``We always recommend that our customers keep the system package up-to-date to include the latest security patches.''
\end{boxH}

\paragraph{Current Status:}
The current status of the update frequency of Anapaya routers remains unclear.
There has been no confirmation on whether Anapaya has made improvements to ensure that routers are shipped with more up-to-date software versions.


\section{Volumetric Attacks}
\label{sec:volumetric-attacks}

In this section we will discuss the results of the volumetric attacks conducted against the CYD Campus network.
The two plots shown in this section have the same structure and axis scaling.
The x-axis represents the amount of traffic in Gigabits per second sent to the CYD Campus in ZÃ¼rich.
It is either Internet traffic or SCION traffic, depending on the attack.

Each plot has a total of three y-axes:
The blue y-axis and bars show the average SCION ping time including indicators for the standard deviation.
The red y-axis and line plot indicate the experienced loss rate during the SCION pings.
Finally, the green y-axis and its corresponding dotted line represent the achieved SCION throughput.

\subsection{Internet Traffic}

The impact of the traditional Internet on SCION is plotted in \cref{fig:internet_traffic}.
Here x-axis represents the amount of Internet traffic in Gigabits per second sent to the public IP address of the CYD Campus in ZÃ¼rich.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.75\textwidth]{internet_analysis_notitle.png}
    \caption{Impact of volumetric Internet traffic on SCION.}
    \label{fig:internet_traffic}
\end{figure}

The results show that the Internet traffic has no impact on SCION's performance between the CYD Campus locations.
The ping times remain stable at around seven milliseconds round-trip time.
Not a single ping packet was lost during the whole experiment.
The achieved SCION bandwidth also remains constant at around 600 Mbit/s, regardless of the amount of Internet traffic sent.
We can therefore conclude that the Internet and SCION links at the CYD Campus in ZÃ¼rich are physically separated and do not interfere with each other.


\subsection{SCION Traffic}

The following plot in \cref{fig:scion_traffic} shows the impact of volumetric SCION traffic.
The x-axis now represents the amount of SCION traffic in Gigabits per second sent towards the border router of the CYD Campus in ZÃ¼rich.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.75\textwidth]{scion_analysis_notitle.png}
    \caption{Impact of volumetric SCION traffic on SCION.}
    \label{fig:scion_traffic}
\end{figure}

The picture for speeds up to 10 Gbit per second is similar to the Internet traffic.
We again have a stable ping time of around seven milliseconds and no packet loss.
The achieved SCION bandwidth is also stable at around 600 Mbit/s.

Recall that the SCION uplink has a capacity of 10 Gbit/s.
When sending 10 Gbit/s or more SCION traffic, we observe a significant degradation in performance.
The ping times increase up to around 17 milliseconds, and its loss rate spikes up to 80\%.
The achieved SCION bandwidth also degrades drastically and sometimes even drops to zero.
In these situations the SCION bandwidth tester was not able to establish a connection to the other side.
This behavior is expected, as the SCION uplink is saturated and the SCION traffic is dropped by the router.
During our experiments, the router did not crash because of that high traffic load.

